name: Rotate Secrets (Mautic)

on:
  workflow_dispatch:
    inputs:
      brand:
        description: "Brand / compose project name"
        required: true
        default: "default"
      backup_before_rotation:
        description: "Backup Mautic before rotating secrets"
        required: false
        default: "true"  
      rotate_db_password:
        description: "Rotate DB password (requires DB user update)"
        required: false
        default: "false"
      rotate_root_password:
        description: "Rotate MySQL ROOT password (DANGEROUS)"
        required: false
        default: "false"
      confirm_root_rotation:
        description: "Type ROTATE_ROOT to confirm"
        required: false

jobs:
  rotate-secrets:
    runs-on: ubuntu-latest
    environment: 
        name: mautic-${{ github.event.inputs.brand}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set brand context
        run: |
          echo "BRAND_NAME=${{ inputs.brand }}" >> $GITHUB_ENV

      # -------------------------
      # SAFETY BACKUP
      # -------------------------
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key

      - name: Backup before rotation
        if: ${{ inputs.backup_before_rotation == 'true' }}
        run: |
          set -euo pipefail

          scp -o StrictHostKeyChecking=no -i ~/.ssh/vps_key scripts/backup_mautic.sh root@${{ vars.LINODE_IP }}:/tmp/backup_mautic.sh

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/vps_key \
            root@${{ vars.LINODE_IP }} "BRAND_NAME='${{ env.BRAND_NAME }}' DB_NAME='${{ vars.DB_NAME }}' MYSQL_ROOT_PASSWORD='${{ secrets.MYSQL_ROOT_PASSWORD }}' bash /tmp/backup_mautic.sh"
    

      # -------------------------
      # OPTIONAL DB PASSWORD ROTATION
      # -------------------------

      - name: Rotate database password (optional)
        if: ${{ inputs.rotate_db_password == 'true' }}
        env:
          BRAND_NAME: ${{ inputs.brand }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          NEW_DB_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          DB_NAME: ${{vars.DB_NAME}}
          MYSQL_USER: ${{vars.MYSQL_USER}}
        run: |
          set -euo pipefail

          scp -o StrictHostKeyChecking=no -i ~/.ssh/vps_key scripts/rotate_db_password.sh root@${{ vars.LINODE_IP }}:/tmp/rotate_db_password.sh

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/vps_key \
            root@${{ vars.LINODE_IP }} "BRAND_NAME='${{ env.BRAND_NAME }}' DB_NAME='${{ vars.DB_NAME }}' MYSQL_ROOT_PASSWORD='${{ secrets.MYSQL_ROOT_PASSWORD }}' NEW_DB_PASSWORD='${{secrets.MYSQL_PASSWORD}}' MYSQL_USER='${{ vars.MYSQL_USER }}' bash /tmp/rotate_db_password.sh"
        

      # -------------------------
      # OPTIONAL DB ROOT PASSWORD ROTATION (BREAK-GLASS)
      # -------------------------

      - name: Validate root password rotation confirmation
        if: ${{ inputs.rotate_root_password == 'true' }}
        run: |
          if [ "${{ inputs.confirm_root_rotation }}" != "ROTATE_ROOT" ]; then
            echo "âŒ Root password rotation requires confirm_root_rotation=ROTATE_ROOT"
            exit 1
          fi
      
    #   Note: you must temporarily store both old and new root passwords
      - name: Rotate MySQL root password (break-glass)
        if: ${{ inputs.rotate_root_password == 'true' }}
        env:
          BRAND_NAME: ${{ inputs.brand }}
          OLD_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD_OLD }}
          NEW_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        run: |
          ./scripts/rotate_mysql_root_password.sh


      # -------------------------
      # RECREATE APPLICATION CONTAINERS
      # -------------------------

      - name: Recreate containers with new secrets
        env:
          BRAND_NAME: ${{ inputs.brand }}
        run: |
          set -euo pipefail

          scp -o StrictHostKeyChecking=no -i ~/.ssh/vps_key scripts/recreate-dc.sh root@${{ vars.LINODE_IP }}:/tmp/recreate-dc.sh
          # Setting vars
          # Replace placeholders in .env
            sed -i "s/__MYSQL_PASSWORD__/${{ secrets.MYSQL_PASSWORD }}/g" .env
            sed -i "s/__MYSQL_ROOT_PASSWORD__/${{ secrets.MYSQL_ROOT_PASSWORD }}/g" .env
            sed -i "s/__DOMAIN__/${{ vars.DOMAIN }}/g" .env
            sed -i "s/__BRAND_NAME__/${{ env.BRAND_NAME }}/g" .env
            sed -i "s/__DB_NAME__/${{ vars.DB_NAME }}/g" .env
            sed -i "s/__DB_USER__/${{ vars.MYSQL_USER }}/g" .env

            # Generate .mautic_env dynamically
            echo "MAUTIC_DB_HOST=mautic_db_${{env.BRAND_NAME}}" > .mautic_env
            echo "MAUTIC_DB_PORT=3306" >> .mautic_env
            echo "MAUTIC_DB_DATABASE=${{ vars.DB_NAME }}" >> .mautic_env
            echo "MAUTIC_DB_USER=${{ vars.MYSQL_USER }}" >> .mautic_env
            echo "MAUTIC_DB_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .mautic_env
            echo "MAUTIC_PORT=80" >> .mautic_env
            echo "MAUTIC_URL=https://${{ vars.DOMAIN }}" >> .mautic_env

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/vps_key \
          root@${{ vars.LINODE_IP }} "BRAND_NAME='${{ env.BRAND_NAME }}' bash /tmp/recreate-dc.sh"
          

      
